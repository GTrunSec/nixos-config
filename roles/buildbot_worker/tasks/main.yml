- name: pacman | install buildbot-worker
  pacman: name=buildbot-worker state=present

- name: buildbot-worker | create base directory
  file:
    path: /var/lib/{{ buildbot_worker_service_name }}/worker
    state: directory

- name: group | {{ buildbot_worker_service_name }}-worker
  group:
    name: "{{ buildbot_worker_service_name }}-worker"
    system: true

- name: user | {{ buildbot_worker_service_name }}-worker
  user:
    name: "{{ buildbot_worker_service_name }}-worker"
    group: "{{ buildbot_worker_service_name }}-worker"
    shell: /usr/bin/nologin
    home: /var/lib/{{ buildbot_worker_service_name }}/worker
    system: true

- name: buildbot-worker | base directory permissions
  file:
    path: "/var/lib/{{ buildbot_worker_service_name }}/worker"
    state: directory
    owner: "{{ buildbot_worker_service_name }}-worker"
    group: "{{ buildbot_worker_service_name }}-worker"
    mode: '0750'
    
- name: buildbot-worker | create worker config
  command: /usr/bin/buildbot-worker create-worker /var/lib/{{ buildbot_worker_service_name }}/worker {{ buildbot_worker_master }} {{ buildbot_worker_name }} {{ buildbot_worker_password }}
  become: yes
  become_user: "{{ buildbot_worker_service_name }}-worker"
  notify:
    - systemd | restart buildbot-worker
  args:
    creates: /var/lib/{{ buildbot_worker_service_name }}/worker/buildbot.tac
    
- name: buildbot-worker | admin file
  notify:
    - systemd | restart buildbot-worker
  template:
    src: base_dir/info/admin.j2
    dest: /var/lib/{{ buildbot_worker_service_name }}/worker/info/admin

- name: buildbot-worker | host file
  notify:
    - systemd | restart buildbot-worker
  template:
    src: base_dir/info/host.j2
    dest: /var/lib/{{ buildbot_worker_service_name }}/worker/info/host
    
- name: systemd | install {{ buildbot_worker_service_name }}-worker.service
  notify:
    - systemd | restart buildbot-worker
  template:
    src: etc/systemd/system/buildbot-worker.service.j2
    dest: /etc/systemd/system/{{ buildbot_worker_service_name }}-worker.service
    owner: root
    group: root
    mode: 0644

- name: systemd | enable {{ buildbot_worker_service_name }}-worker.service
  service: name={{ buildbot_worker_service_name }}-worker.service enabled=true state=started daemon_reload=true
